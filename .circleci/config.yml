version: 2.1
jobs:
  build:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: medium

    # It seems like CircleCI doesn't like it when I override GOPATH.  It just
    # re-overrides my override with its own broken values.  Great.  We set the
    # value inside each and every command so that it actually sticks.

    steps:
      - run:
          command: |
            export GOPATH="$HOME/project/gopath"
            mkdir -p "$GOPATH"

      - checkout:
          path: "/home/circleci/project/gopath/src/k8s.io/kops"

      - run:
          command: |
            export GOPATH="$HOME/project/gopath"
            env

      - run:
          command: |
            export GOPATH="$HOME/project/gopath"
            cd "$GOPATH/src/k8s.io/kops"
            make -d echo-version

      - run:
          name: "Install Bazel 1.0.0"
          command: |
            set -ex

            sudo apt install curl gnupg
            curl -fsSL https://bazel.build/bazel-release.pub.gpg | gpg --dearmor > bazel.gpg
            sudo mv bazel.gpg /etc/apt/trusted.gpg.d/
            echo "deb [arch=amd64] https://storage.googleapis.com/bazel-apt stable jdk1.8" | sudo tee /etc/apt/sources.list.d/bazel.list
            sudo apt update
            sudo apt install bazel-1.0.0

            sudo ln -s `which bazel-1.0.0` "$HOME/bin/bazel"

            bazel --version

      - run:
          command: |
            export GOPATH="$HOME/project/gopath"
            export S3_BUCKET="s3://outreach-custom-kops-assets"
            cd "$GOPATH/src/k8s.io/kops"
            make version-dist CI=1

      - run:
          command: |
            mkdir -p ~/.aws
            cat > ~/.aws/credentials <<EOF
            [default]
            aws_access_key_id=${AWS_ACCESS_KEY_ID}
            aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}
            EOF

      - run:
          command: |
            export GOPATH="$HOME/project/gopath"
            export S3_BUCKET="s3://outreach-custom-kops-assets"
            cd "$GOPATH/src/k8s.io/kops"
            #if [[ "${CIRCLE_BRANCH}" == "master" ]]; then
            make upload CI=1
            #fi
